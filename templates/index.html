<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <title>Registro - Lavanderia IFPI</title>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-dark mb-4 shadow navbar-custom">
      <div class="container">
        <span class="navbar-brand fw-bold">üß∫ Lavanderia IFPI</span>
        <div class="navbar-nav d-flex flex-row gap-3">
          <a class="nav-link active fw-bold" href="/registro">Registro</a>
          <a class="nav-link text-white" href="/gestao">Gest√£o</a>
          <a class="nav-link text-white" href="/consulta">Consultar</a>
          <a class="nav-link text-warning fw-bold" href="/">Sair</a>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="card card-registro shadow mx-auto" style="max-width: 900px">
        <div class="card-body p-4">
          <h2 class="text-center mb-4 fw-bold">
            Lavanderia <span class="text-success">Automatizada</span>
          </h2>

          <div class="row mb-4">
            <div class="col-md-6">
              <label class="form-label fw-bold">Cliente:</label>
              <input
                type="text"
                id="clienteNome"
                class="form-control bg-light"
                required
              />
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Telefone:</label>
              <input
                type="text"
                id="clienteTel"
                class="form-control bg-light"
                placeholder="(99) 99999-9999"
                required
              />
            </div>
          </div>

          <h6 class="fw-bold mb-3">Adicionar Pe√ßas ao Pedido:</h6>
          <div class="p-3 bg-white border rounded-3 mb-4 shadow-sm">
            <div class="row g-2 align-items-end">
              <div class="col-md-3">
                <label class="small fw-bold">Tipo</label>
                <select id="tipoInput" class="form-select">
                  <option value="Camisa">Camisa</option>
                  <option value="Cal√ßa">Cal√ßa</option>
                  <option value="Toalha">Toalha</option>
                  <option value="Roupa Delicada">Delicada</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="small fw-bold">Quantidade</label>
                <input
                  type="number"
                  id="qtdInput"
                  class="form-control"
                  value="1"
                  min="1"
                />
              </div>
              <div class="col-md-2">
                <label class="small fw-bold">Cor</label>
                <input
                  type="text"
                  id="corInput"
                  class="form-control"
                  placeholder="Azul"
                />
              </div>
              <div class="col-md-3">
                <label class="small fw-bold">Servi√ßo</label>
                <select id="servicoInput" class="form-select">
                  <option value="Lavar">Lavar</option>
                  <option value="Secar">Secar</option>
                  <option value="Passar">Passar</option>
                  <option value="Pacote Completo">Completo</option>
                </select>
              </div>
              <div class="col-md-2">
                <button
                  type="button"
                  onclick="adicionarPeca()"
                  class="btn btn-primary w-100 fw-bold"
                >
                  Adicionar
                </button>
              </div>
            </div>
          </div>

          <div class="table-responsive border rounded-3 mb-4">
            <table class="table table-hover mb-0 text-center align-middle">
              <thead class="table-light">
                <tr>
                  <th>Tipo</th>
                  <th>Qtd</th>
                  <th>Cor</th>
                  <th>Servi√ßo</th>
                  <th>Subtotal</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="listaItens"></tbody>
            </table>
          </div>

          <div
            class="p-3 bg-light rounded-3 d-flex justify-content-between align-items-center border"
          >
            <div class="text-end w-100">
              <h4 class="fw-bold text-success mb-0">
                Total: R$ <span id="totalPedido">0.00</span>
              </h4>
              <small
                class="text-danger fw-bold"
                id="avisoDesconto"
                style="display: none"
                >10% de desconto aplicado por volume!</small
              >
            </div>
          </div>

          <button
            onclick="finalizarPedido()"
            class="btn btn-success w-100 py-3 fw-bold mt-4 shadow-sm"
          >
            Finalizar Pedido Completo
          </button>
        </div>
      </div>
    </div>

    <script>
      let carrinho = [];
      const precosBase = {
        Camisa: 15,
        Cal√ßa: 20,
        Toalha: 10,
        "Roupa Delicada": 25,
      };

      function adicionarPeca() {
        const tipo = document.getElementById("tipoInput").value;
        const qtd = parseInt(document.getElementById("qtdInput").value);
        const cor = document.getElementById("corInput").value || "N/A";
        const servico = document.getElementById("servicoInput").value;

        if (qtd < 1) return alert("Quantidade m√≠nima √© 1");

        const item = { tipo, qtd, cor, servico, precoUn: precosBase[tipo] };
        carrinho.push(item);
        atualizarTabela();

        document.getElementById("corInput").value = "";
        document.getElementById("qtdInput").value = "1";
      }

      function removerItem(index) {
        carrinho.splice(index, 1);
        atualizarTabela();
      }

      function atualizarTabela() {
        const corpo = document.getElementById("listaItens");
        corpo.innerHTML = "";
        let bruto = 0;
        let totalQtd = 0;

        carrinho.forEach((item, index) => {
          const subtotal = item.precoUn * item.qtd;
          bruto += subtotal;
          totalQtd += item.qtd;

          corpo.innerHTML += `
            <tr>
              <td>${item.tipo}</td>
              <td>${item.qtd}</td>
              <td>${item.cor}</td>
              <td>${item.servico}</td>
              <td>R$ ${subtotal.toFixed(2)}</td>
              <td><button class="btn btn-sm btn-outline-danger" onclick="removerItem(${index})">Remover</button></td>
            </tr>`;
        });

        let valorFinal = bruto;
        if (totalQtd >= 5) {
          valorFinal = bruto * 0.9;
          document.getElementById("avisoDesconto").style.display = "block";
        } else {
          document.getElementById("avisoDesconto").style.display = "none";
        }

        document.getElementById("totalPedido").innerText =
          valorFinal.toFixed(2);
      }

      async function finalizarPedido() {
        const cliente = document.getElementById("clienteNome").value;
        const telefone = document.getElementById("clienteTel").value;

        if (!cliente || !telefone || carrinho.length === 0) {
          return alert(
            "Preencha os dados do cliente e adicione ao menos uma pe√ßa."
          );
        }

        const payload = { cliente, telefone, itens: carrinho };

        const response = await fetch("/registrar_pedido_multiplo", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (response.ok) {
          window.location.href = "/gestao";
        } else {
          alert("Erro ao registrar pedido.");
        }
      }
    </script>
  </body>
</html>
